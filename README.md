# Deals API

Веб-сервис на базе django, предоставляющий REST-api и
способный:

1. Принимать из POST-запроса .csv файлы для дальнейшей
обработки;
2. Обрабатывать типовые deals.csv файлы, содержащие истории
сделок;
3. Сохранять извлеченные из файла данные в БД проекта;
4. Возвращать обработанные данные в ответе на GET-запрос.

## Зависимости

- Python 3.7+ (на более ранних не проверял)
- Docker
- Docker-compose или плагин Compose на Docker

## Установка

1. Клонируйте репозиторий на вашу локальную машину;
2. Перейдите в корневую директорию проекта;
3. Для запуска **DEV**-версии выполнить  
`docker compose up`;
4. Для запуска **PROD**-версии (на gunicorn-сервере + nginx) выполнить  
`docker compose -f docker-compose.prod.yml up`.

## API Документация

Документация по API доступна по [ссылке](docs/openapi.yaml)

## Использование

- При использовании **DEV**-версии пользоваться портом **8000**
- При использовании **PROD**-версии пользоваться портом **80**

### Загрузка файла для обработки
Метод: POST
Аргументы:
- deals: файл, содержащий историю сделок.  
Ответ:
- Status: OK - файл был обработан без ошибок;
- Status: Error, Desc: <Описание ошибки> - в процессе
обработки файла произошла ошибка.

Для POST-запроса реализована проверка входных данных,
поэтому при неправильных входных данных, их сохранения 
не произойдет. 
Пример ответа сервера при ошибке:
```json
{
  "desc": [
    {
      "row": {
        "total": "ваправып",
        "quantity": "2",
        "date": "2018-12-18 19:43:49.082618"
      },
      "details": {
        "total": [
          "Требуется численное значение."
        ]
      }
    }
  ]
}
```

### Выдача обработанных данных
Метод: GET
В ответе содержится поле “response” со списком из 5 клиентов,
потративших наибольшую сумму за весь период.
Каждый клиент описывается следующими полями:
- username - логин клиента;
- spent_money - сумма потраченных средств за весь период;
- gems - список из названий камней, которые купили как
минимум двое из списка "5 клиентов, потративших
наибольшую сумму за весь период", и данный клиент
является одним из этих покупателей.

Для GET-запроса реализовано кэширование.  
Кэш обновляется при успешном выполнении POST-запроса.

Пример обработанных данных:

```json
{
  "response": [
    {
      "username": "resplendent",
      "spent_money": "451731.00",
      "gems": [
        "Рубин",
        "Сапфир",
        "Танзанит"
      ]
    },
    {
      "username": "bellwether",
      "spent_money": "217794.00",
      "gems": [
        "Петерсит",
        "Сапфир"
      ]
    },
    {
      "username": "uvulaperfly117",
      "spent_money": "120419.00",
      "gems": [
        "Петерсит",
        "Танзанит"
      ]
    },
    {
      "username": "braggadocio",
      "spent_money": "108957.00",
      "gems": [
        "Изумруд"
      ]
    },
    {
      "username": "turophile",
      "spent_money": "100132.00",
      "gems": [
        "Изумруд",
        "Рубин"
      ]
    }
  ]
}
```
